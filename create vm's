#!/bin/bash
set -e

# ===================== CONFIG =====================
TEMPLATE=301
VMID=303
NAME="twentycrm-2"
NODE="host2"
STORAGE="vmdata"             # Ceph storage (gedeeld)
IP="10.24.40.54"
GW="10.24.40.1"
MASK="/24"
BRIDGE="vmbr0"
VLAN=2440
CORES=2
RAM=4096
SSH_PRIV="/root/.ssh/id_ed25519"
SSH_PUB="/root/.ssh/id_ed25519.pub"
# ==================================================

echo "[INFO] Oude VM verwijderen (indien aanwezig)..."
qm stop "$VMID" --skiplock 1 2>/dev/null || true
qm destroy "$VMID" --purge 2>/dev/null || true

echo "[INFO] Nieuwe VM clonen vanaf template ${TEMPLATE} naar ${NODE}..."
qm clone "$TEMPLATE" "$VMID" --name "$NAME" --full 1 --target "$NODE" --storage "$STORAGE"

echo "[INFO] CPU, geheugen en netwerk configureren..."
qm set "$VMID" --cores "$CORES" --memory "$RAM"
qm set "$VMID" --net0 virtio,bridge="$BRIDGE",tag="$VLAN"
qm set "$VMID" --ipconfig0 ip=${IP}${MASK},gw=${GW}
qm set "$VMID" --nameserver 1.1.1.1
qm set "$VMID" --sshkey "$SSH_PUB"
qm set "$VMID" --agent enabled=1

echo "[INFO] VM ${VMID} starten..."
qm start "$VMID"

echo "[INFO] 15 seconden wachten tot de VM online is..."
sleep 15

# -------- Provisioning binnen de VM --------
echo "[INFO] Docker + Twenty installeren op ${IP}..."
ssh -o StrictHostKeyChecking=no -i "$SSH_PRIV" judith@${IP} bash -s <<'VM'
set -e
sudo apt update
sudo apt install -y curl docker.io docker-compose ufw nginx

sudo systemctl enable --now docker

# Firewall
sudo ufw allow OpenSSH
sudo ufw allow 80
sudo ufw allow 443
echo "y" | sudo ufw enable || true

# Twenty CRM
mkdir -p ~/twenty
cd ~/twenty
bash <(curl -sL https://raw.githubusercontent.com/twentyhq/twenty/main/packages/twenty-docker/scripts/install.sh)

echo "[INFO] Containers starten..."
docker compose up -d

echo "[DONE] Twenty draait nu op https://$(hostname -I | awk '{print $1}'):3000"
VM
