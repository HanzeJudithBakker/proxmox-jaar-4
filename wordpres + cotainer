#!/bin/bash
# create-wp1-fixed.sh — WP LXC met robuuste DB-setup (Proxmox 8)

set -euo pipefail

CTID=210 #elke keer aanpassen
HOSTNAME=wp0 #elke keer aanpassen 
IP="10.24.40.100/24" #elke keer aanpassen
GW=10.24.40.1
BRIDGE=vmbr0
TEMPLATE=local:vztmpl/debian-12-standard_12.12-1_amd64.tar.zst
STORAGE=local-lvm
PASSWORD="KUTwachtwoord1239"
MONITOR_IP="10.24.40.51"

# F I X: vaste DB-gegevens (werkt altijd, makkelijk te reproduceren)
DB_NAME="wpdb"
DB_USER="wpuser"
DB_PASS="WpFix123!"         # mag je later wijzigen; WP-config wordt meegepatcht
DB_HOST="127.0.0.1"         # F I X: forceer TCP

echo ">> Container $CTID ($HOSTNAME) wordt aangemaakt…"
pct create "$CTID" "$TEMPLATE" \
  -hostname "$HOSTNAME" \
  -cores 2 -memory 1024 \
  -net0 "name=eth0,bridge=$BRIDGE,ip=$IP,gw=$GW,firewall=1" \
  -storage "$STORAGE" \
  -rootfs "${STORAGE}:30" \
  -onboot 1 \
  -unprivileged 1 \
  -password "$PASSWORD"

pct start "$CTID"

echo ">> OS + WordPress configureren…"
pct exec "$CTID" -- bash -euxc "
  export DEBIAN_FRONTEND=noninteractive
  apt update
  apt -y upgrade
  apt -y install sudo ca-certificates curl wget unzip \
                 apache2 mariadb-server php php-mysql php-zip php-xml php-curl php-mbstring php-gd libapache2-mod-php
  systemctl enable --now apache2 mariadb

  # Users met wachtwoord (tijdelijk; later kun je naar SSH-keys)
  adduser --gecos '' --disabled-password trainer1
  adduser --gecos '' --disabled-password trainer2
  echo 'trainer1:${PASSWORD}' | chpasswd
  echo 'trainer2:${PASSWORD}' | chpasswd
  usermod -aG sudo trainer1
  usermod -aG sudo trainer2

  # SSH wachtwoordlogin tijdelijk aan
  sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || true
  sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || true
  systemctl restart ssh

  # --- F I X --- Robuuste MariaDB + WordPress DB-setup
  # 1) zorg dat MariaDB lokaal luistert en draait
  sed -i 's/^bind-address.*/bind-address = 127.0.0.1/' /etc/mysql/mariadb.conf.d/50-server.cnf || echo 'bind-address = 127.0.0.1' >> /etc/mysql/mariadb.conf.d/50-server.cnf
  systemctl restart mariadb

  # 2) maak DB en user via UNIX socket (geen root-wachtwoord nodig)
  mysql -uroot --protocol=socket <<EOF
CREATE DATABASE IF NOT EXISTS ${DB_NAME} DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
ALTER USER '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

  # 3) WordPress installeren en wp-config patchen met vaste DB-waarden + DB_HOST=127.0.0.1
  wget -q https://wordpress.org/latest.zip -O /tmp/wordpress.zip
  unzip -q /tmp/wordpress.zip -d /tmp/
  rm -rf /var/www/html/*
  mv /tmp/wordpress/* /var/www/html/
  cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
  sed -i \"
    s/define( *'DB_NAME'.*/define('DB_NAME', '${DB_NAME}');/;
    s/define( *'DB_USER'.*/define('DB_USER', '${DB_USER}');/;
    s/define( *'DB_PASSWORD'.*/define('DB_PASSWORD', '${DB_PASS}');/;
  \" /var/www/html/wp-config.php
  grep -q \"define('DB_HOST'\" /var/www/html/wp-config.php \
    && sed -i \"s/define( *'DB_HOST'.*/define('DB_HOST', '${DB_HOST}');/\" /var/www/html/wp-config.php \
    || echo \"define('DB_HOST','${DB_HOST}');\" >> /var/www/html/wp-config.php
  chown -R www-data:www-data /var/www/html
  a2enmod php* rewrite
  systemctl restart apache2

  # Node Exporter (monitoring)
  useradd --no-create-home --system --shell /usr/sbin/nologin nodeexp || true
  VER='v1.8.1'
  curl -fsSL -o /tmp/ne.tar.gz https://github.com/prometheus/node_exporter/releases/download/\$VER/node_exporter-1.8.1.linux-amd64.tar.gz
  tar -xzf /tmp/ne.tar.gz -C /tmp
  install -m 0755 /tmp/node_exporter-*/node_exporter /usr/local/bin/node_exporter
  cat > /etc/systemd/system/node_exporter.service <<SVC
[Unit]
Description=Prometheus Node Exporter
After=network.target
[Service]
User=nodeexp
ExecStart=/usr/local/bin/node_exporter
[Install]
WantedBy=multi-user.target
SVC
  systemctl daemon-reload
  systemctl enable --now node_exporter
"

echo ">> Proxmox container-firewall configureren…"
cat >/etc/pve/firewall/$CTID.fw <<EOF
[OPTIONS]
enable: 1
policy_in: drop
policy_out: accept
[RULES]
IN ACCEPT -p tcp --dport 22
IN ACCEPT -p tcp --dport 80
IN ACCEPT -p tcp --dport 443
IN ACCEPT -s ${MONITOR_IP}/32 -p tcp --dport 9100
EOF

# Kleine health checks
echo ">> Health checks:"
pct exec "$CTID" -- bash -lc "mysql -h${DB_HOST} -u${DB_USER} -p'${DB_PASS}' -e 'SHOW DATABASES;' >/dev/null && echo '  - DB connect: OK'"
pct exec "$CTID" -- bash -lc "curl -I -s http://127.0.0.1 | head -n1"

echo ">> Klaar! Open http://10.24.40.100 (WP-setup)."
echo "   DB: name=${DB_NAME} user=${DB_USER} pass=${DB_PASS} host=${DB_HOST}"
echo "   SSH: trainer1 / trainer2 (wachtwoord: ${PASSWORD})"
